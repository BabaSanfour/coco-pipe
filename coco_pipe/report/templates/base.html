<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 900: '#4c1d95' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        .sidebar-link.active {
            @apply bg-brand-50 text-brand-600 border-r-4 border-brand-500 dark:bg-brand-900/20 dark:text-brand-100;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            @apply bg-gray-300 rounded dark:bg-gray-700;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 antialiased dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

    <!-- Header (Sticky Top) -->
    <header class="bg-white dark:bg-gray-900 shadow-sm sticky top-0 z-50 border-b dark:border-gray-800">
        <div class="max-w-[1600px] mx-auto px-4 h-16 flex justify-between items-center">
            <!-- Brand -->
            <div class="flex items-center space-x-3">
                <svg width="32" height="32" viewBox="0 0 100 100" class="rounded p-0.5 bg-gray-50 dark:bg-gray-800">
                    <defs>
                        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0" stop-color="#6366f1" />
                            <stop offset="1" stop-color="#ec4899" />
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="40" stroke="url(#g)" stroke-width="8" fill="none"
                        transform="rotate(225 50 50)" />
                    <circle cx="50" cy="50" r="8" fill="url(#g)" />
                </svg>
                <div>
                    <h1 class="font-bold text-lg tracking-tight leading-tight">{{ title }}</h1>
                    <div class="text-[10px] uppercase tracking-wider text-gray-500 font-semibold">{{ timestamp }}</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex items-center space-x-4">
                <button onclick="document.getElementById('info-drawer').classList.remove('translate-x-full')"
                    class="text-sm font-medium text-gray-500 hover:text-brand-600 dark:text-gray-400 dark:hover:text-brand-400 transition flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Run Info
                </button>
                <div class="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-2"></div>
                <button onclick="toggleDarkMode()"
                    class="p-2 text-gray-500 hover:bg-gray-100 rounded-full dark:hover:bg-gray-800 transition">
                    <span id="theme-icon">üåô</span>
                </button>
                <div class="md:hidden">
                    <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')"
                        class="p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex-1 max-w-[1600px] mx-auto w-full grid grid-cols-1 md:grid-cols-[280px_1fr] gap-8 pt-6 relative">

        <!-- Sidebar (Sticky) -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-40 w-72 bg-white dark:bg-gray-900 border-r dark:border-gray-800 transform -translate-x-full md:translate-x-0 md:static md:h-[calc(100vh-5rem)] md:w-auto md:bg-transparent transition-transform duration-200 flex flex-col">

            <div class="p-4 border-b dark:border-gray-800 md:hidden bg-gray-50 dark:bg-gray-900 flex justify-between">
                <span class="font-bold">Navigation</span>
                <button onclick="document.getElementById('sidebar').classList.add('-translate-x-full')">‚úï</button>
            </div>

            <!-- Search & Filter -->
            <div
                class="p-4 space-y-3 sticky top-0 bg-gray-50/95 dark:bg-gray-900/95 backdrop-blur z-10 border-b dark:border-gray-800 rounded-t-lg">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search sections..."
                        class="w-full pl-9 pr-3 py-2 text-sm bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md focus:ring-2 focus:ring-brand-500 focus:outline-none shadow-sm">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div class="flex gap-2 text-xs overflow-x-auto pb-1 no-scrollbar">
                    <button
                        class="filter-btn px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 transition whitespace-nowrap active-filter"
                        data-filter="all">All</button>
                    <button
                        class="filter-btn px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 transition whitespace-nowrap"
                        data-filter="warn">‚ö†Ô∏è Warnings</button>
                    <button
                        class="filter-btn px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 transition whitespace-nowrap"
                        data-filter="fail">‚ùå Failures</button>
                </div>
            </div>

            <!-- TOC List -->
            <nav class="flex-1 overflow-y-auto sidebar-scroll p-2 space-y-0.5" id="toc-list">
                {% for item in toc %}
                <a href="#{{ item.id }}"
                    class="toc-link block px-3 py-2 text-sm text-gray-600 dark:text-gray-400 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition flex justify-between items-center group border-l-2 border-transparent"
                    data-title="{{ item.title | lower }}">
                    <span class="flex items-center truncate">
                        {% if item.icon %}<span class="mr-2 opacity-70 group-hover:opacity-100 w-4 text-center">{{
                            item.icon | safe }}</span>{% endif %}
                        {{ item.title }}
                    </span>
                    {% if item.status == 'WARN' %}
                    <span class="w-2 h-2 rounded-full bg-yellow-400" title="Warning"></span>
                    {% elif item.status == 'FAIL' %}
                    <span class="w-2 h-2 rounded-full bg-red-500" title="Critical"></span>
                    {% endif %}
                </a>
                {% endfor %}
            </nav>

            <!-- Findings Summary (Mini) -->
            <div class="p-4 border-t dark:border-gray-800 text-xs text-gray-500">
                <div class="flex justify-between mb-1"><span>Total Sections:</span> <span
                        class="font-mono text-gray-700 dark:text-gray-300">{{ toc|length }}</span></div>
                {% set warns = toc | selectattr('status', 'equalto', 'WARN') | list | length %}
                {% set fails = toc | selectattr('status', 'equalto', 'FAIL') | list | length %}
                {% if warns > 0 or fails > 0 %}
                <div class="mt-2 p-2 bg-red-50 dark:bg-red-900/20 rounded border border-red-100 dark:border-red-800/50">
                    <div class="font-bold text-red-700 dark:text-red-400">Attention Needed</div>
                    <div class="flex gap-3 mt-1">
                        {% if fails > 0 %}<span class="flex items-center text-red-600 font-bold">‚ùå {{ fails }}</span>{%
                        endif %}
                        {% if warns > 0 %}<span class="flex items-center text-yellow-600 font-bold">‚ö†Ô∏è {{ warns
                            }}</span>{% endif %}
                    </div>
                </div>
                {% else %}
                <div class="mt-2 text-green-600 flex items-center"><svg class="w-3 h-3 mr-1" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg> All Checks Passed</div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-full min-w-0 pb-24 px-4 sm:px-0">
            {% block content %}
            <div class="space-y-6" id="main-content-area">
                {{ content | safe }}
            </div>
            {% endblock %}
        </main>
    </div>

    <!-- Run Info Drawer -->
    <div id="info-drawer"
        class="fixed inset-y-0 right-0 z-[60] w-96 bg-white dark:bg-gray-900 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out border-l dark:border-gray-800 flex flex-col">
        <div class="p-4 border-b dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
            <h3 class="font-bold text-lg flex items-center">
                <svg class="w-5 h-5 mr-2 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                Run Information
            </h3>
            <button onclick="document.getElementById('info-drawer').classList.add('translate-x-full')"
                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto flex-1 space-y-6">

            <!-- Environment -->
            <div>
                <h4 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-3">Environment</h4>
                <div
                    class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 text-sm space-y-2 border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between"><span class="text-gray-500">Date (UTC)</span> <span
                            class="font-mono">{{ metadata.timestamp_utc }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Git Commit</span> <span
                            class="font-mono text-brand-600">{{ metadata.git_hash }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Python</span> <span
                            class="font-mono">{{ metadata.python_version }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">OS</span> <span class="font-mono">{{
                            metadata.os_platform }}</span></div>
                </div>
            </div>

            <!-- Configuration -->
            <div>
                <h4 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-3">Configuration</h4>
                <pre
                    class="bg-gray-900 text-gray-100 p-3 rounded-lg text-xs overflow-x-auto font-mono scrollbar-thin scrollbar-thumb-gray-700">{{ config }}</pre>
            </div>

            <!-- Command -->
            <div>
                <h4 class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-3">Execution Command</h4>
                <div
                    class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 text-xs font-mono break-all border border-gray-100 dark:border-gray-700">
                    {{ metadata.command }}
                </div>
            </div>

        </div>
    </div>

    <!-- Global Data Payload (Gzipped Base64) -->
    <script type="application/json" id="report-payload">{{ payload }}</script>

    <!-- Scripts -->
    <script>
        // --- Global Data Store ---
        let REPORT_DATA = {};

        // Decompress Payload on Load
        (function initPayload() {
            const payloadEl = document.getElementById('report-payload');
            if (payloadEl && payloadEl.textContent) {
                try {
                    const b64 = payloadEl.textContent.trim();
                    if (b64) {
                        // Base64 -> Uint8Array
                        const binaryString = atob(b64);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        // Decompress (Gzip -> String)
                        const decompressed = pako.inflate(bytes, { to: 'string' });
                        // Parse JSON
                        REPORT_DATA = JSON.parse(decompressed);
                        console.log(`[Report] Loaded ${Object.keys(REPORT_DATA).length} items from compressed payload.`);
                    }
                } catch (e) {
                    console.error("[Report] Failed to decompress payload:", e);
                }
            }
        })();

        // --- 1. Dark Mode ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';

            // Trigger Plotly redraw if needed (hack to refresh layouts)
            window.dispatchEvent(new Event('resize'));
        }

        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        }

        // --- 2. Search & Filter ---
        const searchInput = document.getElementById('search-input');
        const sections = document.querySelectorAll('section[id]');
        const tocLinks = document.querySelectorAll('.toc-link');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();

            // Filter TOC
            tocLinks.forEach(link => {
                const title = link.getAttribute('data-title');
                if (title.includes(query)) {
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            });

            // Filter Main Content (Optional: might be too jarring to hide sections? Let's keep scrolling)
            // Ideally we just filter the sidebar to help find things.
        });

        // --- 3. ScrollSpy ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Remove active from all
                    tocLinks.forEach(l => l.classList.remove('active', 'bg-brand-50', 'text-brand-600', 'border-r-4', 'border-brand-500', 'dark:bg-brand-900/20', 'dark:text-brand-100'));

                    // Add to current
                    const id = entry.target.id;
                    const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active', 'bg-brand-50', 'text-brand-600', 'border-r-4', 'border-brand-500', 'dark:bg-brand-900/20', 'dark:text-brand-100');
                        activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                }
            });
        }, { rootMargin: '-20% 0px -60% 0px' }); // Trigger when section is near top

        sections.forEach(sec => observer.observe(sec));

        // --- 4. Lazy Loading (Plotly) ---
        // Updated for Phase D: Architecture
        // Logic: 
        // 1. If data-figure exists (legacy/fallback), use inline JSON.
        // 2. If data-id exists, lookup in REPORT_DATA.
        const plotObserver = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const target = entry.target;

                    let figureData = null;

                    // A. Try Global Store (Phase D)
                    const dataId = target.getAttribute('data-id');
                    if (dataId && REPORT_DATA[dataId]) {
                        figureData = REPORT_DATA[dataId];
                    }
                    // B. Try Inline JSON (Legacy/Fallback)
                    else if (target.hasAttribute('data-figure')) {
                        figureData = JSON.parse(target.getAttribute('data-figure'));
                    }

                    if (figureData) {
                        Plotly.newPlot(target, figureData.data, figureData.layout, { responsive: true });
                        target.classList.remove('animate-pulse');
                        target.removeAttribute('data-figure'); // Memory cleanup
                        // Don't remove data-id, might need for debug?
                        obs.unobserve(target);
                    } else {
                        console.warn("[Report] No data found for plot:", dataId || "inline");
                        target.innerHTML = `<div class="text-red-500 text-xs">Error: Plot data missing (${dataId})</div>`;
                        target.classList.remove('animate-pulse');
                    }
                }
            });
        }, { rootMargin: '200px' });

        document.querySelectorAll('.lazy-plot').forEach(p => plotObserver.observe(p));

        // --- 5. Export Table to CSV ---
        function exportTableToCSV(tableId, title) {
            const table = document.getElementById(tableId);
            if (!table) return;

            let csv = [];

            // Get Headers
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                const headers = Array.from(headerRow.querySelectorAll('th')).map(th => `"${th.innerText}"`);
                csv.push(headers.join(","));
            }

            // Get Rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cols = Array.from(row.querySelectorAll('td')).map(td => `"${td.innerText.replace(/"/g, '""')}"`); // Escape quotes
                csv.push(cols.join(","));
            });

            // Download
            const csvFile = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(csvFile);
                link.setAttribute("href", url);
                link.setAttribute("download", `${title || "export"}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- 6. Linked Brushing (Zoom Sync) ---
        // Basic implementation: Sync Zoom across plots of same type/dimensionality?
        // Or just basic log for now.
        // For MVP Phase E, we just stop here.
    </script>
</body>

</html>